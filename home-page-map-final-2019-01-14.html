<html>

<head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.8.3/jquery.js" crossorigin="anonymous"></script>
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.49.0/mapbox-gl.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.49.0/mapbox-gl.css' rel='stylesheet' />
    <!--Chantal: Start-->
    <script src="https://unpkg.com/supercluster@3.0.2/dist/supercluster.min.js"></script>
    <script src="https://npmcdn.com/@turf/turf/turf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chroma-js/1.3.4/chroma.min.js"></script>
    <!--Chantal: End-->

    <script>



    </script>

</head>

<body>

    <div>
        <div id='map' style='width: 100%; height: 450px;'></div>
        <img style="display:none" id="image_warning" src="img/warning2.png" />
    </div>
    <div class="TabStructure">
        <button type="button" name="btn" class="trigger_buttons _people_at_risk"  onclick="toggleMap('PeopleAtRisk')">People At Risk</button>
        <button type="button" name="btn" class="trigger_buttons _buildings_at_risk"  onclick="toggleMap('BuildingsAtRisk')">Buildings At Risk</button>

        <button type="button" name="btn" class="trigger_buttons _travelling_soon"  onclick="toggleMap('TravellingSoon','Medical')">Travelling Soon Medical</button>
        <button type="button" name="btn" class="trigger_buttons _travelling_soon"  onclick="toggleMap('TravellingSoon','Security')">Travelling Soon Security</button>

        <button type="button" name="btn" class="trigger_buttons _travelling_now"  onclick="toggleMap('ThereNow','Medical')">There Now Medical</button>
        <button type="button" name="btn" class="trigger_buttons _travelling_now"  onclick="toggleMap('ThereNow','Security')">There Now Security</button>

        <button type="button" name="btn" class="trigger_buttons _case"  onclick="toggleMap('Case')">Case</button>
    </div>

    <script>

        /*MapBox_Global_Custom_JS - Start*/
        var firstMapLoaded = false;
        var popup;
        var _travellingSoonLinkId = "";
        var _thereNowLinkId = "";
        var _mapType = "";

        var mapNameEnum = {
            PEOPLE_AT_RISK: "PeopleAtRisk",
            BUILDINGS_AT_RISK: "BuildingsAtRisk",
            TRAVELING_SOON: "TravellingSoon",
            THERE_NOW: "ThereNow",
            CASE: "Case"
        };

        var app = {
            map: "",
            config: "",
            dataPeopleAtRisk: "",
            dataBuildingsAtRisk: "",
            dataTravellingSoonMedical: "",
            dataTravellingSoonSecurity: "",
            dataThereNowMedical: "",
            dataThereNowSecurity: "",
            dataCase: "",
            testMapCluster: "",
            testClusterData: "",
            setConfigurationForMap: function (mapName) {
                var config = {
                    propToAgg: "",
                    selectValue: "",
                    secondaryPropToAgg: ""
                }
                switch (mapName) {
                    case "BuildingsAtRisk":
                        config.propToAgg = "buildingId";
                        config.selectValue = "unique";
                        config.secondaryPropToAgg = "alertId";
                        break;
                    case "PeopleAtRisk":
                        config.propToAgg = "travelerProfileId";
                        config.selectValue = "unique";
                        config.secondaryPropToAgg = "alertId";
                        break;
                    case "TravellingSoon":
                    case "ThereNow":
                        config.propToAgg = "travelerProfileId";
                        config.selectValue = "unique";
                        config.secondaryPropToAgg = "countryName";
                        break;
                    case "Case":
                        config.propToAgg = "totalCount";
                        config.selectValue = "sum";
                        config.secondaryPropToAgg = "countryName";
                        break;
                    default:
                }
                this.config = config;
            },
            getDataForSpecificMap: function (mapName, type) {
                if (type === undefined) {
                    type = "";
                }

                return app["data" + mapName + type];
            },
            initializeMapbox: function (accessToken, containerId, styleUrl, zoomLevel) {
                mapboxgl.accessToken = accessToken;

                var map = new mapboxgl.Map({
                    container: containerId,
                    style: styleUrl,
                    zoom: zoomLevel,
                    renderWorldCopies: false,
                    maxBounds: [[-480, -55], [480, 85]],
                    center: [-4.53873952326, 54.2241891077]
                });

                var navigationControl = new mapboxgl.NavigationControl();
                //addCartoCopyWrite();
                $('#' + containerId).on('mouseenter', function () {
                    map.addControl(navigationControl);
                    //addCartoCopyWrite();
                });

                $('#' + containerId).on('mouseleave', function () {
                    map.removeControl(navigationControl);
                });

                this.map = map;
                this.map.resize();
            },
            prepareMap: function (mapName, type) {
                this.setConfigurationForMap(mapName);
                var data = this.getDataForSpecificMap(mapName, type);
                console.log(data);

                //var mapCluster = performSuperClustering(this.config.propToAgg, 20, 14, this.config.secondaryPropToAgg, mapName);
                app.testMapCluster = performSuperClustering(this.config.propToAgg, 20, 14, this.config.secondaryPropToAgg, mapName);
                try {
                    app.testMapCluster.load(data.features);
                    // CREATE THE MAP
                    initmap(this.map, '', this.config.selectValue, this.config.propToAgg, data.features, mapName, type);
                } catch (exception) { "prepareMap - No Dataset Available" }
                this.map.resize();
            },
            removeMapLayerAndSource: function () {
                try {
                    if (app.map.getLayer("clusters")) {
                        this.map.removeLayer("clusters");
                        this.map.removeLayer("unclustered-point");
                        this.map.removeLayer("cluster-count");
                        this.map.removeLayer("uncluster-count");
                    }
                    this.map.removeSource("building_earthquakes"); /*check this later... it has been to building_earthquakes*/
                } catch (exception) { "removeMapLayerAndSource - No Dataset Available" }
            },
            toggleMap: function (mapName, type) {
                try {
                    popup.remove();
                    this.removeMapLayerAndSource();
                    this.setConfigurationForMap(mapName);
                    this.prepareMap(mapName, type);
                    if (mapName === mapNameEnum.TRAVELING_SOON || mapName === mapNameEnum.THERE_NOW) {
                        var data = app.getDataForSpecificMap(mapName, type);
                        var url;
                        _mapType = type; //not sure if it needs to clear
                        if (type === 'Medical') {
                            url = data.medicalUrl;
                        } else {
                            url = data.securityUrl;
                        };
                        //_thereNowLinkId _travellingSoonLinkId
                        if (mapName === mapNameEnum.TRAVELING_SOON) {
                            $("#" + _travellingSoonLinkId).attr("href", url);
                            $("#" + _travellingSoonLinkId).attr("target", "_blank");
                        }
                        if (mapName === mapNameEnum.THERE_NOW) {
                            $("#" + _thereNowLinkId).attr("href", url);
                            $("#" + _thereNowLinkId).attr("target", "_blank");
                        }
                    }
                } catch (exception) { "toggleMap - No Dataset Available" }
            },
            getContentForDistinctSecondary: function (mapName, secPropToAgg, properties) {
                var content = "";
                switch (mapName) {
                    case mapNameEnum.PEOPLE_AT_RISK:
                    case mapNameEnum.BUILDINGS_AT_RISK:
                        content = properties[secPropToAgg] + "}{" + properties["alertLocation"] + "}{" + properties["alertTitle"];
                        break;
                    case mapNameEnum.TRAVELING_SOON:
                    case mapNameEnum.THERE_NOW:
                        content = properties[secPropToAgg] + "}{" + properties["riskRating"] + "}{" + properties["countryCode"];
                        break;
                    case mapNameEnum.CASE:
                        content = properties[secPropToAgg] + "}{" + properties["totalCount"];
                        break;
                }
                return content;
            },
            getPopupContent: function (e, mapName, type) {
                if (type === undefined) {
                    type = "";
                }
                var distinctSecondary = JSON.parse(e.features[0].properties.distinctArraySecondary);
                var htmlString;

                switch (mapName) {
                    case mapNameEnum.PEOPLE_AT_RISK:
                    case mapNameEnum.BUILDINGS_AT_RISK:
                        htmlString = "<span class='OpenSans_Regular' style='font-size:13px'>Special Advisory</span><br><div style='margin-top:8px'>";
                        for (var i = 0; i < distinctSecondary.length; i++) {
                            var strArr = distinctSecondary[i].split('}{');

                            htmlString = htmlString + (i + 1) + ". <a class='custom-hyperlink' href='AlertDetails.aspx?AlertsId=" + strArr[0] + "'>" + strArr[1] + " | " + strArr[2] + "</a>";
                            if (i != distinctSecondary.length - 1) {
                                htmlString = htmlString + "</br>";
                            }
                        }
                        htmlString = htmlString + '</div>';
                        break;
                    case mapNameEnum.TRAVELING_SOON:
                    case mapNameEnum.THERE_NOW:
                        for (record in distinctSecondary) {
                            var strArr = distinctSecondary[record].split('}{');
                            htmlString = "<span class='OpenSans_Regular' style='font-size:13px'>" + strArr[1] + " " + type + " Risk</span><br>" +
                                "<div style='margin-top:8px'>" + "<a class='custom-hyperlink' href='DestinationDetails.aspx?CountryISO=" + strArr[2] + "'>" + strArr[0] + "</a></div>";
                        }
                        break;
                    case mapNameEnum.CASE:
                        for (record in distinctSecondary) {
                            var strArr = distinctSecondary[record].split('}{');
                            htmlString = "<span class='OpenSans_Regular' style='font-size:13px'>" + strArr[0] + "</span><br>" +
                                "<div style='margin-top:8px'>Cases: <a href='CaseUpdates.aspx'>" + strArr[1] + "</a></div>";
                        }
                        break;
                }

                return htmlString;
            },
            getPopupContentUnclustered: function (e, mapName, type) {
                if (type === undefined) {
                    type = "";
                }
                var unclustered = e.features[0].properties;
                console.log(unclustered);
                var htmlString;

                switch (mapName) {
                    case mapNameEnum.PEOPLE_AT_RISK:
                    case mapNameEnum.BUILDINGS_AT_RISK:
                        htmlString = "<span class='OpenSans_Regular' style='font-size:13px'>Special Advisory</span><br>" +
                            "<div style='margin-top:8px'><a class='custom-hyperlink' href='AlertDetails.aspx?AlertsId=" + unclustered.alertId + "'>" + unclustered.alertLocation + " | " + unclustered.alertTitle + "</a></div>";
                        break;
                    case mapNameEnum.TRAVELING_SOON:
                    case mapNameEnum.THERE_NOW:
                        htmlString = "<span class='OpenSans_Regular' style='font-size:13px'>" + unclustered.riskRating + " " + type + " Risk</span><br>" +
                            "<div style='margin-top:8px'><a class='custom-hyperlink' href='DestinationDetails.aspx?CountryISO=" + unclustered.countryCode + "'>" + unclustered.countryName + "</a></div>";
                        break;
                    case mapNameEnum.CASE: {
                        htmlString = "<span class='OpenSans_Regular' style='font-size:13px'>" + unclustered.countryName + "</span><br>" +
                            "<div style='margin-top:8px'>Cases: <a href='CaseUpdates.aspx'>" + unclustered.totalCount + "</a></div>";
                    }
                        break;
                }
                return htmlString;
            },

        }

        function getData(numOfPeopleAtRiskId, numOfBuildingsAtRiskId, numOfTravellingSoonId, numOfThereNowId, numOfOpenCasesId, peopleAtRiskApiUrl, buildingsAtRiskApiUrl, travellingApiUrl, caseApiUrl, authorization, userId, travellingSoonType, thereNowType, sfdcAccountId, travellingSoonLinkId, thereNowLinkId, peopleAtRiskDespId, buildingsAtRiskDespId, isMedical, isSecurity) {
            //addCartoCopyWrite();
            //app.setConfigurationForMap(mapNameEnum.PEOPLE_AT_RISK);

            var peopleAtRiskApiUrl = peopleAtRiskApiUrl + '?' + 'Authorization=' + authorization + '&' + 'UserId=' + userId + '&' + '&' + 'IsMedical=' + isMedical + '&' + 'IsSecurity=' + isSecurity;
            var buildingsAtRiskApiUrl = buildingsAtRiskApiUrl + '?' + 'Authorization=' + authorization + '&' + 'UserId=' + userId + '&' + 'IsMedical=' + isMedical + '&' + 'IsSecurity=' + isSecurity;

            var travellingSoonApiUrl = travellingApiUrl + '?' + 'Authorization=' + authorization + '&UserId=' + userId + '&Type=' + travellingSoonType;
            var thereNowApiUrl = travellingApiUrl + '?' + 'Authorization=' + authorization + '&UserId=' + userId + '&Type=' + thereNowType;

            var caseApiUrl = caseApiUrl + '?' + 'SfdcAccountId=' + sfdcAccountId + '&' + 'Authorization=' + authorization + '&UserId=' + userId;

            console.log(peopleAtRiskApiUrl);
            console.log(buildingsAtRiskApiUrl);
            console.log(travellingSoonApiUrl);
            console.log(thereNowApiUrl);
            console.log(caseApiUrl);

            var getPeopleAtRiskData =
                $.when($.ajax({
                    url: peopleAtRiskApiUrl,
                    type: 'GET',
                    beforeSend: function (xhr) {
                    }
                }));


            var getBuildingsAtRiskData =
                $.when($.ajax({
                    url: buildingsAtRiskApiUrl,
                    type: 'GET',
                    beforeSend: function (xhr) {
                    }
                }));


            var getTravellingSoonData =
                $.when($.ajax({
                    url: travellingSoonApiUrl,
                    type: 'GET',
                    beforeSend: function (xhr) {
                    }
                }));


            var getThereNowData =
                $.when($.ajax({
                    url: thereNowApiUrl,
                    type: 'GET',
                    beforeSend: function (xhr) {
                    }
                }));


            var getCaseData =
                $.when($.ajax({
                    url: caseApiUrl,
                    type: 'GET',
                    beforeSend: function (xhr) {
                    }
                }));

            //addCartoCopyWrite();

            getPeopleAtRiskData.then(function (peopleAtRiskData, textStatus, jqXHR) {
                // Check is map initialise
                app.dataPeopleAtRisk = peopleAtRiskData;
                $('#' + peopleAtRiskDespId).text(app.dataPeopleAtRisk.description);
                $('#' + numOfPeopleAtRiskId).text(app.dataPeopleAtRisk.affectedNumber);
                $('.MapBox_People_At_Risk').removeClass('MapBox_DisableDivContents');
                if (firstMapLoaded === false) {
                    firstMapLoaded = true;
                    toggleTabsForPeopleAndBuildingAtRisk();
                    $('div.FiveTabs.MapBox_People_At_Risk div.TabStructure').addClass('Active')
                    app.toggleMap(mapNameEnum.PEOPLE_AT_RISK);
                }

            });

            getBuildingsAtRiskData.then(function (buildingsAtRiskData, textStatus, jqXHR) {
                try {
                    app.dataBuildingsAtRisk = buildingsAtRiskData;
                    $('#' + numOfBuildingsAtRiskId).text(app.dataBuildingsAtRisk.affectedNumber);
                    $('#' + buildingsAtRiskDespId).text(app.dataBuildingsAtRisk.description);
                    $('.MapBox_Buildings_At_Risk').removeClass('MapBox_DisableDivContents');
                    if (firstMapLoaded === false) {
                        firstMapLoaded = true;
                        toggleTabsForPeopleAndBuildingAtRisk();
                        $('div.FiveTabs.MapBox_Buildings_At_Risk div.TabStructure').addClass('Active')
                        app.toggleMap(mapNameEnum.BUILDINGS_AT_RISK);
                    }
                } catch (exception) {
                    app.dataBuildingsAtRisk = [];
                }

            });


            getTravellingSoonData.then(function (travellingSoonData, textStatus, jqXHR) {
                try {
                    console.log(travellingSoonData);
                    _travellingSoonLinkId = travellingSoonLinkId;
                    app.dataTravellingSoonMedical = travellingSoonData.Api_GetTravelerSummary_GeoJSON[0];
                    app.dataTravellingSoonSecurity = travellingSoonData.Api_GetTravelerSummary_GeoJSON[1];

                    $('#' + numOfTravellingSoonId).text(app.dataTravellingSoonMedical.affectedNumber);
                    $("#" + _travellingSoonLinkId).attr("href", app.dataTravellingSoonSecurity.securityUrl);
                    $("#" + _travellingSoonLinkId).attr("target", "_blank");
                    $('.MapBox_Travelling_Soon').removeClass('MapBox_DisableDivContents');
                    if (firstMapLoaded === false) {
                        firstMapLoaded = true;
                        toggleTabsForTravellingSoon();
                        $('div.FiveTabs.MapBox_Travelling_Soon div.TabStructure').addClass('Active')
                        app.toggleMap(mapNameEnum.TRAVELING_SOON, 'Security');
                    }
                } catch (exception) {
                    app.dataTravellingSoonMedical = [];
                    app.dataTravellingSoonSecurity = []
                }

            })


            getThereNowData.then(function (thereNowData, textStatus, jqXHR) {
                try {
                    console.log(thereNowData);
                    _thereNowLinkId = thereNowLinkId;
                    app.dataThereNowMedical = thereNowData.Api_GetTravelerSummary_GeoJSON[0];
                    app.dataThereNowSecurity = thereNowData.Api_GetTravelerSummary_GeoJSON[1];

                    $('#' + numOfThereNowId).text(app.dataThereNowMedical.affectedNumber);
                    $("#" + _thereNowLinkId).attr("href", app.dataThereNowSecurity.securityUrl);
                    $("#" + _thereNowLinkId).attr("target", "_blank");
                    $('.MapBox_Travelling_Now').removeClass('MapBox_DisableDivContents');
                    if (firstMapLoaded === false) {
                        firstMapLoaded = true;
                        toggleTabsForThereNow();
                        $('div.FiveTabs.MapBox_Travelling_Now div.TabStructure').addClass('Active')
                        app.toggleMap(mapNameEnum.THERE_NOW, 'Security');
                    }
                } catch (exception) {
                    app.dataThereNowMedical = [];
                    app.dataThereNowSecurity = [];

                }

            });

            getCaseData.then(function (caseData, textStatus, jqXHR) {
                try {
                    app.dataCase = caseData;
                    $('#' + numOfOpenCasesId).text(app.dataCase.affectedNumber);
                    $('.MapBox_Case').removeClass('MapBox_DisableDivContents');
                    if (firstMapLoaded === false) {
                        firstMapLoaded = true;
                        toggleTabsForCase();
                        $('div.FiveTabs.MapBox_Case div.TabStructure').addClass('Active')
                        app.toggleMap(mapNameEnum.CASE);
                    }
                } catch (exception) {
                    app.dataCase = [];
                }

            });

            popup = new mapboxgl.Popup({
                anchor: 'top',
                closeOnClick: true
            })
        }
        /******************************MapBox_Global_Custom_JS - End******************************/

        /*HomePage_JS - Start*/
        function _toConsumableArray(arr) { if (Array.isArray(arr)) { for (var i = 0, arr2 = Array(arr.length); i < arr.length; i++) { arr2[i] = arr[i]; } return arr2; } else { return Array.from(arr); } }

        function updateClusters(mapBox, clusterData, repaint, propertyToAggregate, select_value, colorStops, radiusStops, mapName) {
            var currentZoom = mapBox.getZoom();
            var worldBounds = [-180.0, -90.0, 180.0, 90.0];
            app.testClusterData = turf.featureCollection(
                app.testMapCluster.getClusters(worldBounds, Math.floor(currentZoom))
            );
            //console.log("updateClusters-repainting: " + mapName);
            if (repaint && mapName != null) {
                /*
                mapBox.setPaintProperty('clusters', 'circle-color', {
                    property: select_value,
                    stops: colorStops
                });
                mapBox.setPaintProperty('clusters', 'circle-radius', {
                    property: select_value,
                    stops: radiusStops
                });
                mapBox.setPaintProperty('unclustered-point', 'circle-color', {
                    property: propertyToAggregate,
                    stops: colorStops
                }); */
                mapBox.setLayoutProperty('cluster-count', "text-field", "{" + select_value + "}");
                mapBox.setLayoutProperty('uncluster-count', "text-field", "{" + select_value + "}");
            }
        }

        function initmap(mapBox, mapCluster, selectValue, propToAgg, dataFeatures, mapName, type) {
            var worldBounds = [-180.0000, -90.0000, 180.0000, 90.0000];
            var currentZoom = mapBox.getZoom();
            try {
                app.testClusterData = turf.featureCollection(app.testMapCluster.getClusters(worldBounds, Math.floor(currentZoom)));

                var select_value = selectValue; //"unique";
                var color = 'YlOrRd';
                //var select_el = "unique";
                var propertyToAggregate = propToAgg; //console.log('selectValue ' + selectValue); console.log('selectValue ' + selectValue); ; //"id";
                var stops_domain = chroma.limits(getFeatureDomain(app.testClusterData, select_value), 'e', 8);
                var scale = chroma.scale(color).domain(stops_domain).mode('lab');
                var colorStops = createColorStops(stops_domain, scale);
                var radiusStops = createRadiusStops(stops_domain, 10, 25);
                console.log('selectValue ' + selectValue);
                console.log('propToAgg ' + propToAgg);
            } catch (exception) { "initmap - No Dataset Available" }
            updateClusters(mapBox, '', false, propertyToAggregate, select_value, colorStops, radiusStops, mapName);

            mapBox.addSource("building_earthquakes", {
                type: "geojson",
                data: app.testClusterData,//
                buffer: 1,
                maxzoom: 14
            });
            try {
                mapBox.addLayer({
                    id: "clusters",
                    type: "circle",
                    source: "building_earthquakes",
                    filter: ["has", "point_count"],
                    paint: {
                        "circle-color": [
                            'match',
                            ["to-string", ['get', 'distinctArrayTSTN']],
                            //'High', 'rgba(243, 45, 27, 0.65)',
                            '["High"]', '#f32d1b',
                            '["Extreme"]', '#9f0000',
                            //'Extreme', 'rgb(159, 0, 0, 0.65)',
                            //'rgba(212, 0, 44, 0.65)'
                            '#d4002c'
                            //'#000000'
                        ],
                        //"circle-opacity": 0.65,
                        "circle-radius": 20,
                        "circle-stroke-color": "#d9a3b6",
                        "circle-stroke-width": 0.6,
                        "circle-stroke-opacity": 0.5
                    }
                }, "waterway-label");
                mapBox.addLayer({
                    id: "cluster-count",
                    type: "symbol",
                    source: "building_earthquakes",
                    filter: ["has", "point_count"],
                    layout: {
                        "text-field": "{" + select_value + "}",
                        "text-font": ["DIN Offc Pro Medium", "Arial Unicode MS Bold"],
                        "text-size": 14
                    },
                    paint: {
                        "text-color": "white"
                    }
                });
                mapBox.addLayer({
                    id: "unclustered-point",
                    type: "circle",
                    source: "building_earthquakes",
                    filter: ["!has", "point_count"],
                    paint: {
                        "circle-color": [
                            'match',
                            ['get', 'riskRating'],
                            //'High', 'rgba(243, 45, 27, 0.65)',
                            'High', '#f32d1b',
                            'Extreme', '#9f0000',
                            //'Extreme', 'rgb(159, 0, 0, 0.65)',
                            //'rgba(212, 0, 44, 0.65)'
                            '#d4002c'
                            //'#000000'
                        ],
                        //"circle-opacity": 0.65,
                        "circle-radius": 20,
                        "circle-stroke-color": "#d9a3b6",
                        "circle-stroke-width": 0.6,
                        "circle-stroke-opacity": 0.5
                    }
                }, "waterway-label");
                switch (mapName) {
                    case mapNameEnum.TRAVELING_SOON:
                    case mapNameEnum.THERE_NOW:
                        mapBox.addLayer({
                            id: "uncluster-count",
                            type: "symbol",
                            source: "building_earthquakes",
                            filter: ["!has", "point_count"],
                            layout: {
                                "text-field": "1",
                                "text-font": ["DIN Offc Pro Medium", "Arial Unicode MS Bold"],
                                "text-size": 14
                            },
                            paint: {
                                "text-color": "white"
                            }
                        });
                        break;
                    case mapNameEnum.PEOPLE_AT_RISK:
                        mapBox.addLayer({
                            id: "uncluster-count",
                            type: "symbol",
                            source: "building_earthquakes",
                            filter: ["!has", "point_count"],
                            layout: {
                                "text-field": ['match',
                                    ['get', 'travelerProfileId'],
                                    'null', '0',
                                    '1'
                                ],
                                "text-font": ["DIN Offc Pro Medium", "Arial Unicode MS Bold"],
                                "text-size": 14
                            },
                            paint: {
                                "text-color": "white"
                            }
                        });
                        break;
                    case mapNameEnum.BUILDINGS_AT_RISK:
                        mapBox.addLayer({
                            id: "uncluster-count",
                            type: "symbol",
                            source: "building_earthquakes",
                            filter: ["!has", "point_count"],
                            layout: {
                                "text-field": ['match',
                                    ['get', 'buildingId'],
                                    'null', '0',
                                    '1'
                                ],
                                "text-font": ["DIN Offc Pro Medium", "Arial Unicode MS Bold"],
                                "text-size": 14
                            },
                            paint: {
                                "text-color": "white"
                            }
                        });
                        break;
                    case mapNameEnum.CASE:
                        mapBox.addLayer({
                            id: "uncluster-count",
                            type: "symbol",
                            source: "building_earthquakes",
                            filter: ["!has", "point_count"],
                            layout: {
                                "text-field": ["to-string", ['get', 'totalCount']],
                                "text-font": ["DIN Offc Pro Medium", "Arial Unicode MS Bold"],
                                "text-size": 14
                            },
                            paint: {
                                "text-color": "white"
                            }
                        });
                        break;
                }
            } catch (exception) { "addLayer - No Dataset Available" }
            mapBox.on('zoom', function () {
                newZoom = mapBox.getZoom();
                if (Math.floor(currentZoom) == 0) {
                    currentZoom = 1;
                };
                if (Math.floor(newZoom) != Math.floor(currentZoom)) {
                    currentZoom = newZoom;
                    updateClusters(mapBox, '', true, propertyToAggregate, select_value, colorStops, radiusStops, null);
                    mapBox.getSource('building_earthquakes').setData(app.testClusterData);
                }
            });

            mapBox.on('mouseenter', 'clusters', function () {
                mapBox.getCanvas().style.cursor = 'pointer';
            });

            mapBox.on('mouseleave', 'clusters', function () {
                mapBox.getCanvas().style.cursor = '';
            });

            mapBox.on('mouseenter', 'unclustered-point', function () {
                mapBox.getCanvas().style.cursor = 'pointer';
            });

            mapBox.on('mouseleave', 'unclustered-point', function () {
                mapBox.getCanvas().style.cursor = '';
            });

            mapBox.on('click', 'clusters', function (e) {
                var latLng = e.features[0].geometry.coordinates;
                var superC = supercluster({ radius: 50 }).load(dataFeatures);
                var currentZoom = parseInt(mapBox.getZoom());
                var thisCluster = superC.getClusters([e.lngLat.lng - 1, e.lngLat.lat - 1, e.lngLat.lng + 1, e.lngLat.lat + 1], currentZoom);
                var clusterId;
                for (var i = 0; i < thisCluster.length; i++) {
                    if (thisCluster[i].properties) {
                        if (thisCluster[i].properties.cluster) {
                            clusterId = thisCluster[i].properties.cluster_id;
                        }
                    }
                }
                mapBox.flyTo({ center: latLng, zoom: 3 });
                if (clusterId || clusterId === 0) {
                    var zoom = superC.getClusterExpansionZoom(clusterId, currentZoom);
                    if (currentZoom >= 3) {

                        //console.log(e.features[0].properties.distinctArraySecondary);
                        var htmlString = app.getPopupContent(e, mapName, type);
                        // attach htmlstring to popup

                        popup.setLngLat(latLng)
                            .setHTML(htmlString)
                            .addTo(mapBox);
                        return;
                    }
                    if (zoom > 3) {
                        zoom = 3;
                    }
                    mapBox.flyTo({ center: latLng, zoom: zoom });
                }
            });


            mapBox.on('click', 'unclustered-point', function (e) {
                console.log(e.features[0].properties);
                var htmlString = app.getPopupContentUnclustered(e, mapName, type);
                var latLng = e.features[0].geometry.coordinates;
                var superC = supercluster({ radius: 50 }).load(dataFeatures);
                var currentZoom = parseInt(mapBox.getZoom());
                popup.setLngLat(latLng)
                    .setHTML(htmlString)
                    .addTo(mapBox)
                return;
                /*if (currentZoom >= 3) {
                    popup.setLngLat(latLng)
                    .setHTML(htmlString)
                    .addTo(mapBox)
                    return;
                }
                if (currentZoom < 3) {
                    currentZoom = 3;
                }
                mapBox.flyTo({ center: latLng, zoom: currentZoom });*/
            });

        };

        function getFeatureDomain(geojson_data, myproperty) {
            var data_domain = [];
            turf.propEach(geojson_data, function (currentProperties, featureIndex) {
                data_domain.push(Math.round(Number(currentProperties[myproperty]) * 100 / 100));
            });
            return data_domain;
        }

        function createColorStops(stops_domain, scale) {
            var stops = [];
            stops_domain.forEach(function (d) {
                //stops.push([d, scale(d).hex()])
                stops.push([d, scale(23456).hex()]); // Chantal: Temporarily Changed
            });
            return stops;
        }

        function createRadiusStops(stops_domain, min_radius, max_radius) {
            var stops = [];
            var stops_len = stops_domain.length;
            var count = 1;
            stops_domain.forEach(function (d) {
                stops.push([d, min_radius + count / stops_len * (max_radius - min_radius)]);
                count += 1;
            });
            return stops;
        }

        function performSuperClustering(propertyToAggregate, clusterRadius, clusterMaxZoom, secondaryPropertyToAggregate, mapName) {
            return supercluster({
                radius: clusterRadius,
                maxZoom: clusterMaxZoom,
                initial: function initial() {
                    return {
                        count: 0,
                        sum: 0,
                        min: Infinity,
                        max: -Infinity,
                        unique: 0,
                        uniqueSecondary: 0,
                        consolidatedArray: [],
                        distinctArraySecondary: [],
                        distinctArrayTSTN: []
                    };
                },
                map: function map(properties) {
                    return {
                        count: 1,
                        sum: Number(properties[propertyToAggregate]),
                        min: Number(properties[propertyToAggregate]),
                        max: Number(properties[propertyToAggregate]),
                        unique: 1,
                        uniqueSecondary: 1,
                        consolidatedArray: Number(properties[propertyToAggregate]),
                        distinctArraySecondary: app.getContentForDistinctSecondary(mapName, secondaryPropertyToAggregate, properties),//properties[secondaryPropertyToAggregate] + "}{" + properties["alertLocation"] + "}{" + properties["alertTitle"], //SUJAN
                        distinctArrayTSTN: properties["riskRating"],
                        placeholder: properties[propertyToAggregate] //placeholder: Number(properties[propertyToAggregate])
                    };
                },
                reduce: function reduce(accumulated, properties) {
                    accumulated.sum += Math.round(properties.sum * 100) / 100;
                    accumulated.count += properties.count;
                    accumulated.min = Math.round(Math.min(accumulated.min, properties.min) * 100) / 100;
                    accumulated.max = Math.round(Math.max(accumulated.max, properties.max) * 100) / 100;
                    accumulated.avg = Math.round(100 * accumulated.sum / accumulated.count) / 100;

                    if (accumulated.consolidatedArray.indexOf(properties.consolidatedArray) == -1 && properties.placeholder != null) { // added third condition for 1746
                        if (properties.placeholder != "null") {
                            accumulated.unique += properties.unique;
                            //alert(acculumated.unique + " AND standalone unique: " + properties.unique);
                            accumulated.consolidatedArray.push(properties.consolidatedArray);
                        }
                        accumulated.distinctArraySecondary.push(properties.distinctArraySecondary);
                        accumulated.distinctArrayTSTN.push(properties.distinctArrayTSTN);
                    } else {
                        accumulated.unique += properties.unique;
                        if (Array.isArray(properties.consolidatedArray)) {
                            accumulated.consolidatedArray = [].concat(_toConsumableArray(accumulated.consolidatedArray), _toConsumableArray(properties.consolidatedArray));
                            accumulated.distinctArraySecondary = [].concat(_toConsumableArray(accumulated.distinctArraySecondary), _toConsumableArray(properties.distinctArraySecondary));
                            accumulated.distinctArrayTSTN = [].concat(_toConsumableArray(accumulated.distinctArrayTSTN), _toConsumableArray(properties.distinctArrayTSTN));
                        }
                        var temp = new Set(accumulated.consolidatedArray);
                        var tempSecondary = new Set(accumulated.distinctArraySecondary);
                        var tempTSTN = new Set(accumulated.distinctArrayTSTN);
                        accumulated.unique = temp.size;
                        accumulated.distinctArraySecondary = Array.from(tempSecondary);
                        accumulated.uniqueSecondary = tempSecondary.size;
                        accumulated.distinctArrayTSTN = Array.from(tempTSTN);
                    }
                }
            });
        }
        /*HomePage_JS - End*/




        $(document).ready(function () {

            app.initializeMapbox("pk.eyJ1IjoiaW50ZXJuYXRpb25hbHNvcyIsImEiOiJjamo1cDNpOWsxdnB2M3BzMjAzNWk1b2FoIn0.49i92ZK8WKifgkSEKtDB7Q",
                "map", 'mapbox://styles/mapbox/streets-v9', 1);


            var numOfPeopleAtRiskId = "";
            var numOfBuildingsAtRiskId = "";
            var numOfTravellingSoonId = "";
            var numOfThereNowId = "";
            var numOfOpenCasesId = "";
            var peopleAtRiskApiUrl = "https://aihpl-dev.outsystemsenterprise.com/MyAssist/rest/api/GetRiskAlertSummary";
            var buildingsAtRiskApiUrl = "https://aihpl-dev.outsystemsenterprise.com/MyAssist/rest/api/GetBuildingsSummary";
            var travellingApiUrl = "https://aihpl-dev.outsystemsenterprise.com/MyAssist/rest/api/GetTravelerSummary";
            var caseApiUrl = "https://aihpl-dev.outsystemsenterprise.com/MyAssist/rest/api/GetCasesSummary";
            var authorization = "123";
            //var userId = "Rekhastage@isos.com";
            var userId = "johnny.cooper@internationalsos.com";
            var partyId = "1227";
            var travellingSoonType = "TRAVELING_SOON";
            var thereNowType = "THERE_NOW";
            var sfdcAccountId = 1227;
            var travellingNowLinkId = "";
            var thereNowLinkId = ""
            var peopleAtRiskDespId = ""
            var buildingsAtRiskDespId = ""
            var isMedical = "True"
            var isSecurity = "True"

            getData(
                numOfPeopleAtRiskId,
                numOfBuildingsAtRiskId,
                numOfTravellingSoonId,
                numOfThereNowId,
                numOfOpenCasesId,
                peopleAtRiskApiUrl,
                buildingsAtRiskApiUrl,
                travellingApiUrl,
                caseApiUrl,
                authorization,
                userId,
                travellingSoonType,
                thereNowType,
                sfdcAccountId,
                travellingNowLinkId,
                thereNowLinkId,
                peopleAtRiskDespId,
                buildingsAtRiskDespId,
                isMedical,
                isSecurity);
        });

        /* UI Function*/
        function toggleMap(mapName, type) {
            try { app.toggleMap(mapName, type) } catch (exception) { "toggleMap - No Dataset Available" }
        }
    </script>

</body>

</html>